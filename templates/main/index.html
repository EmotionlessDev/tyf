{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="utf-8">
   <title>
      {% block title %}
      Tell your friends
      {% endblock %}
   </title>
   <meta content="width=device-width, initial-scale=1.0" name="viewport">
   <meta content="" name="keywords">
   <meta content="" name="description">
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet">
   <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap"
      rel="stylesheet">
   <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
   <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
   <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">

   <link href="{% static 'css/style.css' %}" rel="stylesheet">

   {% block head %}{% endblock %}
</head>

<body>
   <div class="content--canvas">
         
   </div>
   <div class="container-fluid position-relative d-flex p-0">
      <div id="spinner"
         class="show bg-dark position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
         <div class="spinner-border text-primary" style="width: 3rem;
               height: 3rem;
               color: var(--primary) !important" role="status">
            <span class="sr-only">Loading...</span>
         </div>
      </div>
      <div class="sidebar pe-0 pb-3 border border-2 open" style="border-right: 0.1px solid var(--secondary) !important;
            background-color: var(--dark) !important">
         <nav id="sidebar-nav" class="navbar bg-secondary navbar-dark align-items-center"
            style="background-color: var(--dark) !important">

            <p class=" text-break fs-9 w-100 p-3" style="color: var(--secondary-light);">
               What's the rush?
               <br />
               Just relax and enjoy another hour of free studying with
               <em>Tell Your Friends!</em>
            </p>

            <div class="navbar-nav ps-3 w-100">
               <div class="nav-item dropdown">
                  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">üìö Collections</a>
                  <div class="dropdown-menu bg-transparent border-0">
                     {% for collection in collections %}
                     <a href="signin.html" class="dropdown-item">{{ collection }}</a>
                     {% endfor %}
                  </div>
               </div>
               <div class="nav-item dropdown">
                  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">üìÅ Categories</a>
                  <div class="dropdown-menu bg-transparent border-0">
                     {% for category in categories %}
                     <a href="signin.html" class="dropdown-item">{{ category }}</a>
                     {% endfor %}
                  </div>
               </div>
               <div class="nav-item dropdown">
                  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">üîñ Tags</a>
                  <div class="dropdown-menu bg-transparent border-0">
                     {% for tag in tags %}
                     <a href="signin.html" class="dropdown-item">{{ tag }}</a>
                     {% endfor %}
                  </div>
               </div>
            </div>

         </nav>

         <div>
            <a href="https://github.com/EmotionlessDev/tyf" class="dropdown-item">‚≠ê Support Us</a>
            <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ" class="dropdown-item">üõ†Ô∏è Report a bug</a>
         </div>
      </div>
      <div class="content open">
         <nav class="navbar navbar-expand bg-secondary navbar-dark sticky-top px-4 py-0" style="background-color: var(--dark) !important;
               border-bottom: 0.1px solid var(--secondary) !important">
            <a href="{% url 'index' %}" class="navbar-brand d-flex me-4">
               <img class="" src="{% static 'img/logo.svg' %}" alt="" style="height: 35px">

            </a>
            <a href="#" class="sidebar-toggler flex-shrink-0">
               <i class="bi bi-list fs-4 text-light"></i>
            </a>
            <form class="ms-4 w-100">
               <input id="search-input" class="form-control bg-dark fs-7 border-0" type="search" placeholder="Search">
            </form>
            <a href="{% url 'post_add' %}" class="btn btn-outline-primary fs-8 ms-4 action-super">+ Create</a>
            <div class="navbar-nav align-items-center ms-0">

               <div class="nav-item dropdown">
                  {% if user.is_authenticated %}
                  <a href="{% url 'profile' username=request.user.profile.username %}" class="nav-link dropdown-toggle ms-0"
                     data-bs-toggle="dropdown">
                     <img class="rounded-circle me-lg-0" src="{{ user.profile.get_avatar }}" alt="" style="width: 30px;
                        height: 30px">
                  </a>
                  {% else %}
                  <a href="{% url 'login' %}" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                     <img class="rounded-circle me-lg-0" src="{% static 'img/default_avatar.webp' %}" alt="" style="width: 30px;
                           height: 30px">
                  </a>
                  {% endif %}
                  <div class="dropdown-menu dropdown-menu-end bg-dark border-secondary border-top-0 rounded-0 rounded-bottom fs-8">
                     {% if user.is_authenticated %}
                     <a href="{% url 'profile' username=request.user.profile.username %}" class="dropdown-item">Profile</a>
                     {% endif %}
                     {% if user.is_authenticated %}
                     <a href="{% url 'logout' %}" class="dropdown-item">Log Out</a>
                     {% else %}
                     <a href="{% url 'login' %}" class="dropdown-item">Log In</a>
                     {% endif %}
                  </div>
               </div>
            </div>
         </nav>

         <div class="main__content container">
               <div class="main_background"></div>
            <div class="row position-relative">
               <div class="col-9">
                  {% block content %}
                  <div id="search-container"></div>
                  <div class="h-100 p-4 row" id="posts"></div>
                  {% endblock %}
               </div>
               <div class="col-3" id="recent-users">
                  <!-- recent users sidebar -->
                  <div class="card bg-transparent p-2 mt-4">
                        <h5 class="text-light>">Recent Users</h5>
                  </div>
               </div>
            </div>
         </div>

         <div class="container-fluid p-0">
            <div class="bg-dark rounded-top mt-4 p-0">
               <div class="d-flex align-items-center justify-content-between p-4">
                  <div class="col-12 col-sm-6 text-center text-sm-start fs-9 text-muted">
                     &copy; <a href="{% url 'index' %}">Tell Your Friends</a>, All Right Reserved.
                  </div>
                  <div class="d-flex align-items-center gap-1">
                     <a href="https://github.com/EmotionlessDev/tyf" class="text-muted">
                        <i class="bi bi-github"></i>
                     </a>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <a href="{% url 'post_add' %}" class="post-add-btn">+</a>
   </div>

   <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
      crossorigin="anonymous">
      </script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Clamp.js/0.5.1/clamp.min.js"></script>

   <script>
      let offset = 0;
      const limit = 12;
      let search_term = "";
      $.ajaxSetup({
         headers: {"X-CSRFToken": '{{csrf_token}}'}
      });
      const postContainer = document.getElementById('posts');
      const searchContainer = document.getElementById('search-container');
      // document.getElementById("search-input").addEventListener("input", loadSearchContent);


      if (postContainer.innerText === "") {
         if ('{{ request.get_full_path }}' === "/") {
            loadMoreContent();
         }
      }

      window.onscroll = function () {
         if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
            if ('{{ request.get_full_path }}' === "/") {
               offset += limit;
               loadMoreContent();
            }
         }
      };

      // async function loadSearchContent() {
      //    search_term = $("#search-input").val();

      //    if (search_term.length >= 0) {
      //       if (search_term.length == 0) {
      //          searchContainer.innerHTML = "";
      //       } else if (search_term.length == 1) {
      //          offset = 0;
      //          postContainer.innerHTML = "";
      //          searchContainer.innerHTML = 
      //          `
      //          <div class="p-4 text-center pb-1" style="color: var(--secondary-light);">
      //             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
      //                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
      //             </svg>
      //             The search term "<span id="search-term"></span>" returned <span id="search-count"></span> posts.
      //             <hr>
      //          </div>
      //          `;
      //       }
      //       await loadMoreContent();
      //    }
      //    console.log(search_term);
      // }

      function loadMoreContent() {
         let payload = {
            "offset": offset,
            "limit": limit,
            "search": search_term,
         }
         $.ajax({
            type: "POST",
            url: 'load_posts/',
            contentType: 'application/json',
            dataType: "json",
            data: JSON.stringify(payload),
            success: function (data) {
               console.log(data);
               if (data.loading === false) {
                  if (postContainer.innerText != "") {
                     offset -= limit;
                  }
               } else {
                  if (data.search) {
                     console.log(data);
                  }
                  if (search_term != "") {
                     document.getElementById('search-term').innerHTML = search_term;
                     document.getElementById('search-count').innerHTML = data.posts.length;
                  }

                  for (let i = 0; i < data.posts.length; i++) {
                     if (data.posts !== null) {
                        postContainer.innerHTML += createPostElement(data.posts[i]);
                     }
                  }
                  textTruncate();
               }
            },
         });
      }

      function createPostElement(post) {
         var regex = /<([a-z]+)>(.+)<\/([a-z]+)>/ig;
         var content_array = regex.exec(post.content);

         var fst_elm_content = "";
         if (content_array !== null) {
            fst_elm_content = content_array[0];
         } else {
            fst_elm_content = post.content;
         }

         var postElement =
            `
            <div class="col-md-6 border-4";">
               <a href="post/` + post.identifier + `/">
                  <div class="card bg-dark p-1 mb-4 scale-on-hover"
                       style="border: 1px solid var(--primary) !important; border-left:0 !important; border-top:0 !important;">
                     <div class="card-body fs-7">
                        <h5 class="card-title truncate fs-3">
            `
            + post.title +
            `
                        </h5>
                        <div class="post-description fs-6 card-text truncate mb-2" 
                             style="color: var(--light); !important">
            `
            + fst_elm_content +
            `
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                           <div class="d-flex align-items-center">
                              <span class="language-dot"></span>
                              <small class="text-muted"></small>
                           </div> 
                           <div class="stars">` + post.stars + ` ‚òÖ</div>
                        </div>
                        <div class="d-block justify-content-between mt-2 text-muted text-truncate">
                           <p>
                              <strong>` + post.author + `</strong>
                           </p>
                           <p>
                              <strong>` + post.created_at + `</strong>
                           </p>
                        </div>
                     </div>
                  </div>
               </a>
            </div>
            `
         return postElement;
      }

      function textTruncate() {
         var truncate_p = document.querySelector(".truncate p");
         $clamp(truncate_p, {
            clamp: 2,
            useNativeClamp: false
         });

         var truncate_span = document.querySelector(".truncate span");
         $clamp(truncate_span, {
            clamp: 2,
            useNativeClamp: false
         });

         for (let i = 1; i < 7; i++) {
            $clamp(document.querySelector(`.truncate h${i}`), {
               clamp: 2,
               useNativeClamp: false
            });
         }
      }
   </script>
      <script src="{% static 'js/noise.min.js' %}"></script>
      <script src="{% static 'js/util.js' %}"></script>
      <script src="{% static 'js/coalesce.js' %}"></script>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
   <script src="{% static 'js/main.js' %}"></script>

</body>

</html>
